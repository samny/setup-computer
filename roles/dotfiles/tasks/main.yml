---
- name: Create backup directory for existing dotfiles
  ansible.builtin.file:
    path: "{{ dotfiles_backup_dir }}"
    state: directory
    mode: "0755"

- name: Ensure XDG config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config"
    state: directory
    mode: "0755"

- name: Ensure XDG local share directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/share"
    state: directory
    mode: "0755"

- name: Check if gitconfig exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.gitconfig"
  register: gitconfig_stat

- name: Backup existing gitconfig
  ansible.builtin.copy:
    src: "{{ ansible_facts['env']['HOME'] }}/.gitconfig"
    dest: "{{ dotfiles_backup_dir }}/.gitconfig"
    remote_src: true
  when: gitconfig_stat.stat.exists

- name: Create gitconfig from template
  ansible.builtin.template:
    src: gitconfig.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.gitconfig"
    mode: "0644"

- name: Find existing Fish config
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/fish"
  register: fish_config_stat

- name: Backup existing Fish config
  ansible.builtin.copy:
    src: "{{ ansible_facts['env']['HOME'] }}/.config/fish"
    dest: "{{ dotfiles_backup_dir }}/fish"
    remote_src: true
  when: fish_config_stat.stat.exists and fish_config_stat.stat.isdir

- name: Create Fish config directory
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/fish"
    state: directory
    mode: "0755"

- name: Link Fish config from dotfiles
  ansible.builtin.file:
    src: "{{ playbook_dir }}/../dotfiles/config/fish/config.fish"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/fish/config.fish"
    state: link
    force: true

- name: Find existing Starship config
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/starship.toml"
  register: starship_config_stat

- name: Backup existing Starship config
  ansible.builtin.copy:
    src: "{{ ansible_facts['env']['HOME'] }}/.config/starship.toml"
    dest: "{{ dotfiles_backup_dir }}/starship.toml"
    remote_src: true
  when: starship_config_stat.stat.exists

- name: Link Starship config from dotfiles
  ansible.builtin.file:
    src: "{{ playbook_dir }}/../dotfiles/config/starship.toml"
    dest: "{{ ansible_facts['env']['HOME'] }}/.config/starship.toml"
    state: link
    force: true
