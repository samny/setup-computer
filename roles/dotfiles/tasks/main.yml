---
- name: Create backup directory for existing dotfiles
  ansible.builtin.file:
    path: "{{ dotfiles_backup_dir }}"
    state: directory
    mode: "0755"

- name: Ensure XDG config directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config"
    state: directory
    mode: "0755"

- name: Ensure XDG local share directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.local/share"
    state: directory
    mode: "0755"

- name: Check if gitconfig exists
  ansible.builtin.stat:
    path: "{{ ansible_facts['env']['HOME'] }}/.gitconfig"
  register: gitconfig_stat

- name: Backup existing gitconfig
  ansible.builtin.copy:
    src: "{{ ansible_facts['env']['HOME'] }}/.gitconfig"
    dest: "{{ dotfiles_backup_dir }}/.gitconfig"
    remote_src: true
  when: gitconfig_stat.stat.exists

- name: Create gitconfig from template
  ansible.builtin.template:
    src: gitconfig.j2
    dest: "{{ ansible_facts['env']['HOME'] }}/.gitconfig"
    mode: "0644"

- name: Set dotfiles list
  ansible.builtin.set_fact:
    dotfiles_list:
      - {
          src: "git/ignore",
          dest: "{{ ansible_facts['env']['HOME'] }}/.config/git/ignore",
          parent_dir: "{{ ansible_facts['env']['HOME'] }}/.config/git",
        }
      - {
          src: "fish/config.fish",
          dest: "{{ ansible_facts['env']['HOME'] }}/.config/fish/config.fish",
          parent_dir: "{{ ansible_facts['env']['HOME'] }}/.config/fish",
          backup_name: "fish",
        }
      - {
          src: "starship.toml",
          dest: "{{ ansible_facts['env']['HOME'] }}/.config/starship.toml",
          parent_dir: "{{ ansible_facts['env']['HOME'] }}/.config",
          backup_name: "starship.toml",
        }

- name: Configure dotfiles
  block:
    - name: Check for existing configs
      ansible.builtin.stat:
        path: "{{ item.dest }}"
      register: dotfile_stats
      loop: "{{ dotfiles_list }}"
      loop_control:
        label: "{{ item.src }}"

    - name: Backup existing configs
      ansible.builtin.copy:
        src: "{{ item.item.dest }}"
        dest: "{{ dotfiles_backup_dir }}/{{ item.item.backup_name | default(item.item.src | basename) }}"
        remote_src: true
      loop: "{{ dotfile_stats.results }}"
      loop_control:
        label: "{{ item.item.src }}"
      when: item.stat.exists and item.item.backup_name is defined

    - name: Ensure config parent directories exist
      ansible.builtin.file:
        path: "{{ item.parent_dir }}"
        state: directory
        mode: "0755"
      loop: "{{ dotfiles_list }}"
      loop_control:
        label: "{{ item.parent_dir }}"

    - name: Create symlinks for dotfiles
      ansible.builtin.file:
        src: "{{ playbook_dir }}/../dotfiles/config/{{ item.src }}"
        dest: "{{ item.dest }}"
        state: link
        force: true
      loop: "{{ dotfiles_list }}"
      loop_control:
        label: "{{ item.src }}"
