---
- name: Create backup directory for GNOME settings
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/.config/gnome-settings-backups"
    state: directory
    mode: '0755'

- name: Get current timestamp for backup
  ansible.builtin.set_fact:
    backup_timestamp: "{{ ansible_facts['date_time']['iso8601_basic_short'] }}"

- name: Backup current GNOME settings
  ansible.builtin.shell: |
    dconf dump / > "{{ ansible_facts['env']['HOME'] }}/.config/gnome-settings-backups/gnome-settings-{{ backup_timestamp }}.dconf"
  changed_when: true

- name: Display backup location
  ansible.builtin.debug:
    msg: "GNOME settings backed up to: {{ ansible_facts['env']['HOME'] }}/.config/gnome-settings-backups/gnome-settings-{{ backup_timestamp }}.dconf"

# Keyboard Mapping - Swap Command and Control keys (left and right)
- name: Swap Command and Control keys for Apple keyboard behavior
  ansible.builtin.shell: |
    gsettings set org.gnome.desktop.input-sources xkb-options "['ctrl:swap_lwin_lctl', 'ctrl:swap_rwin_rctl']"
  changed_when: true
# # Keyboard Shortcuts - Overview (Activities)
# - name: Disable default Super key for overview
#   ansible.builtin.shell: |
#     gsettings set org.gnome.mutter overlay-key ''
#   changed_when: true

# - name: Set Overview keyboard shortcut to Ctrl+Space (Cmd+Space)
#   ansible.builtin.shell: |
#     gsettings set org.gnome.shell.keybindings toggle-overview "['<Control>space']"
#   changed_when: true

# # Keyboard Shortcuts - Switch Applications
# - name: Set switch applications shortcut to Ctrl+Tab (Cmd+Tab)
#   ansible.builtin.shell: |
#     gsettings set org.gnome.desktop.wm.keybindings switch-applications "['<Control>Tab']"
#   changed_when: true

# - name: Set switch applications backward shortcut to Ctrl+Shift+Tab
#   ansible.builtin.shell: |
#     gsettings set org.gnome.desktop.wm.keybindings switch-applications-backward "['<Control><Shift>Tab']"
#   changed_when: true

# # Touchpad Settings - Apple Trackpad Optimization
# - name: Disable tap to click on touchpad
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.touchpad tap-to-click false
#   changed_when: true

# - name: Enable two-finger right-click
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.touchpad click-method 'fingers'
#   changed_when: true

# - name: Enable natural scrolling (Mac-style)
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.touchpad natural-scroll true
#   changed_when: true

# - name: Disable edge scrolling (use two-finger only)
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.touchpad edge-scrolling-enabled false
#   changed_when: true

# - name: Set touchpad speed (optimized for Apple trackpad)
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.touchpad speed 0.3
#   changed_when: true

# - name: Enable touchpad acceleration
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.touchpad accel-profile 'adaptive'
#   changed_when: true

# - name: Enable middle-click emulation (three-finger tap)
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.touchpad middle-click-emulation true
#   changed_when: true

# # Mouse Settings
# - name: Enable natural scrolling for mouse (Mac-style)
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.mouse natural-scroll true
#   changed_when: true

# - name: Set mouse acceleration profile
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.mouse accel-profile 'adaptive'
#   changed_when: true

# - name: Set mouse speed
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.mouse speed 0.0
#   changed_when: true

# # Keyboard Behavior
# - name: Set keyboard delay
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.keyboard delay 200
#   changed_when: true

# - name: Set keyboard repeat rate
#   ansible.builtin.shell: gsettings set org.gnome.desktop.peripherals.keyboard repeat-interval 30
#   changed_when: true

# # Display & UI Settings
# - name: Enable fractional scaling for HiDPI displays
#   ansible.builtin.shell: gsettings set org.gnome.mutter experimental-features "['scale-monitor-framebuffer']"
#   changed_when: true

# - name: Enable Night Light
#   ansible.builtin.shell: gsettings set org.gnome.settings-daemon.plugins.color night-light-enabled true
#   changed_when: true

# - name: Set Night Light temperature (warmer)
#   ansible.builtin.shell: gsettings set org.gnome.settings-daemon.plugins.color night-light-temperature 3700
#   changed_when: true

# - name: Enable Night Light schedule (sunset to sunrise)
#   ansible.builtin.shell: gsettings set org.gnome.settings-daemon.plugins.color night-light-schedule-automatic true
#   changed_when: true

# # Power Management
# - name: Check if lid-close-ac-action key exists
#   ansible.builtin.shell: gsettings list-keys org.gnome.settings-daemon.plugins.power | grep -q lid-close-ac-action
#   register: lid_close_key_exists
#   changed_when: false
#   failed_when: false

# - name: Suspend on lid close (AC power) - if supported
#   ansible.builtin.shell: gsettings set org.gnome.settings-daemon.plugins.power lid-close-ac-action 'suspend'
#   changed_when: true
#   when: lid_close_key_exists.rc == 0

# - name: Suspend on lid close (battery) - if supported
#   ansible.builtin.shell: gsettings set org.gnome.settings-daemon.plugins.power lid-close-battery-action 'suspend'
#   changed_when: true
#   when: lid_close_key_exists.rc == 0

# - name: Show battery percentage in top bar
#   ansible.builtin.shell: gsettings set org.gnome.desktop.interface show-battery-percentage true
#   changed_when: true

# # Audio Settings
# - name: Enable over-amplification (volume >100%)
#   ansible.builtin.shell: gsettings set org.gnome.desktop.sound allow-volume-above-100-percent true
#   changed_when: true

# # Window Management
# - name: Enable focus follows mouse (sloppy mode)
#   ansible.builtin.shell: gsettings set org.gnome.desktop.wm.preferences focus-mode 'sloppy'
#   changed_when: true

# - name: Attach modal dialogs to parent windows
#   ansible.builtin.shell: gsettings set org.gnome.mutter attach-modal-dialogs true
#   changed_when: true

# - name: Center new windows
#   ansible.builtin.shell: gsettings set org.gnome.mutter center-new-windows true
#   changed_when: true

# # Firefox Scroll Speed Configuration
# - name: Check if Firefox profiles directory exists
#   ansible.builtin.stat:
#     path: "{{ ansible_env.HOME }}/.mozilla/firefox"
#   register: firefox_dir

# - name: Find Firefox profile directories
#   ansible.builtin.find:
#     paths: "{{ ansible_env.HOME }}/.mozilla/firefox"
#     patterns: "*.default*"
#     file_type: directory
#   register: firefox_profiles
#   when: firefox_dir.stat.exists

# - name: Create user.js in Firefox profile to reduce scroll speed
#   ansible.builtin.lineinfile:
#     path: "{{ item.path }}/user.js"
#     line: 'user_pref("mousewheel.default.delta_multiplier_x", 50);'
#     create: true
#     mode: "0644"
#   loop: "{{ firefox_profiles.files }}"
#   when: firefox_dir.stat.exists and firefox_profiles.files | length > 0

# - name: Set Firefox Y scroll speed multiplier
#   ansible.builtin.lineinfile:
#     path: "{{ item.path }}/user.js"
#     line: 'user_pref("mousewheel.default.delta_multiplier_y", 50);'
#     create: true
#     mode: "0644"
#   loop: "{{ firefox_profiles.files }}"
#   when: firefox_dir.stat.exists and firefox_profiles.files | length > 0
