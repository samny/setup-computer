---
- name: Set Finder to always show list view
  community.general.osx_defaults:
    domain: com.apple.finder
    key: FXPreferredViewStyle
    type: string
    value: "Nlsv"
    state: present

# - name: Show hidden files in Finder
#   community.general.osx_defaults:
#     domain: com.apple.finder
#     key: AppleShowAllFiles
#     type: bool
#     value: true
#     state: present

# - name: Show path bar in Finder
#   community.general.osx_defaults:
#     domain: com.apple.finder
#     key: ShowPathbar
#     type: bool
#     value: true
#     state: present

- name: Show all filename extensions
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleShowAllExtensions
    type: bool
    value: true
    state: present

- name: Enable Dock auto-hide
  community.general.osx_defaults:
    domain: com.apple.dock
    key: autohide
    type: bool
    value: true
    state: present

- name: Set Dock icon size
  community.general.osx_defaults:
    domain: com.apple.dock
    key: tilesize
    type: float
    value: 48.0
    state: present

# - name: Set key repeat rate (fastest)
#   community.general.osx_defaults:
#     domain: NSGlobalDomain
#     key: KeyRepeat
#     type: int
#     value: 2
#     state: present

# - name: Set initial key repeat delay
#   community.general.osx_defaults:
#     domain: NSGlobalDomain
#     key: InitialKeyRepeat
#     type: int
#     value: 15
#     state: present

# - name: Enable tap to click
#   community.general.osx_defaults:
#     domain: com.apple.AppleMultitouchTrackpad
#     key: Clicking
#     type: bool
#     value: true
#     state: present

# - name: Set tracking speed
#   community.general.osx_defaults:
#     domain: NSGlobalDomain
#     key: com.apple.trackpad.scaling
#     type: float
#     value: 1.5
#     state: present

- name: Set default save location to Downloads
  community.general.osx_defaults:
    domain: com.apple.screencapture
    key: location
    type: string
    value: "{{ ansible_facts['env']['HOME'] }}/Downloads"
    state: present

- name: Remove corrupted Terminal preferences if exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/Library/Preferences/com.apple.Terminal.plist"
    state: absent
  when: false # Only run manually if Terminal won't start
  tags: [never, fix-terminal]

- name: Ensure iTerm2 DynamicProfiles directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/iTerm2/DynamicProfiles"
    state: directory
    mode: "0755"

- name: Create iTerm2 dynamic profile for FiraCode Nerd Font
  ansible.builtin.copy:
    content: |
      {
        "Profiles": [
          {
            "Name": "FiraCode Nerd Font",
            "Guid": "FiraCode-Profile-NerdFont",
            "Dynamic Profile Parent Name": "Default",
            "Normal Font": "FiraCodeNerdFontMono-Regular 13",
            "Use Non-ASCII Font": false,
            "ASCII Ligatures": true,
            "Horizontal Spacing": 1.0,
            "Vertical Spacing": 1.0
          }
        ]
      }
    dest: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/iTerm2/DynamicProfiles/firacode.json"
    mode: "0644"

- name: Display font configuration message
  ansible.builtin.debug:
    msg: |
      FiraCode Nerd Font has been installed.

      To configure Terminal.app manually:
        1. Terminal → Settings → Profiles
        2. Select a profile (e.g., "Basic")
        3. Click "Font" → Change to "FiraCodeNerdFont-Regular" size 13
        4. Set as default profile

      To configure iTerm2:
        1. Open iTerm2 → Settings → Profiles
        2. Select "FiraCode" profile
        3. Other Actions → Set as Default

      If Terminal won't start, reset preferences with:
        rm ~/Library/Preferences/com.apple.Terminal.plist

- name: Restart Finder to apply changes
  ansible.builtin.command: killall Finder
  changed_when: true
  failed_when: false

- name: Restart Dock to apply changes
  ansible.builtin.command: killall Dock
  changed_when: true
  failed_when: false
