---
- name: Set Finder to always show list view
  community.general.osx_defaults:
    domain: com.apple.finder
    key: FXPreferredViewStyle
    type: string
    value: "Nlsv"
    state: present

# - name: Show hidden files in Finder
#   community.general.osx_defaults:
#     domain: com.apple.finder
#     key: AppleShowAllFiles
#     type: bool
#     value: true
#     state: present

# - name: Show path bar in Finder
#   community.general.osx_defaults:
#     domain: com.apple.finder
#     key: ShowPathbar
#     type: bool
#     value: true
#     state: present

- name: Show all filename extensions
  community.general.osx_defaults:
    domain: NSGlobalDomain
    key: AppleShowAllExtensions
    type: bool
    value: true
    state: present

- name: Enable Dock auto-hide
  community.general.osx_defaults:
    domain: com.apple.dock
    key: autohide
    type: bool
    value: true
    state: present

- name: Set Dock icon size
  community.general.osx_defaults:
    domain: com.apple.dock
    key: tilesize
    type: float
    value: 48.0
    state: present

# - name: Set key repeat rate (fastest)
#   community.general.osx_defaults:
#     domain: NSGlobalDomain
#     key: KeyRepeat
#     type: int
#     value: 2
#     state: present

# - name: Set initial key repeat delay
#   community.general.osx_defaults:
#     domain: NSGlobalDomain
#     key: InitialKeyRepeat
#     type: int
#     value: 15
#     state: present

# - name: Enable tap to click
#   community.general.osx_defaults:
#     domain: com.apple.AppleMultitouchTrackpad
#     key: Clicking
#     type: bool
#     value: true
#     state: present

# - name: Set tracking speed
#   community.general.osx_defaults:
#     domain: NSGlobalDomain
#     key: com.apple.trackpad.scaling
#     type: float
#     value: 1.5
#     state: present

- name: Set default save location to Downloads
  community.general.osx_defaults:
    domain: com.apple.screencapture
    key: location
    type: string
    value: "{{ ansible_facts['env']['HOME'] }}/Downloads"
    state: present

- name: Configure Terminal.app to use FiraCode Nerd Font
  ansible.builtin.shell: |
    # Close Terminal.app if running
    killall Terminal 2>/dev/null || true
    sleep 1
    
    # Set font for the default "Basic" profile using defaults
    defaults write com.apple.Terminal "Window Settings" -dict-add "Basic" "$(defaults read com.apple.Terminal "Window Settings" | plutil -extract Basic xml1 -o - - | sed 's|<string>Monaco 10</string>|<string>FiraCodeNerdFont-Regular 13</string>|g' | plutil -convert binary1 -o - - | base64)"
    
    # Set Basic as default profile
    defaults write com.apple.Terminal "Default Window Settings" -string "Basic"
    defaults write com.apple.Terminal "Startup Window Settings" -string "Basic"
  args:
    executable: /bin/bash
  changed_when: true
  failed_when: false

- name: Ensure iTerm2 DynamicProfiles directory exists
  ansible.builtin.file:
    path: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/iTerm2/DynamicProfiles"
    state: directory
    mode: "0755"

- name: Create iTerm2 dynamic profile for FiraCode Nerd Font
  ansible.builtin.copy:
    content: |
      {
        "Profiles": [
          {
            "Name": "FiraCode",
            "Guid": "FiraCode-Profile",
            "Dynamic Profile Parent Name": "Default",
            "Normal Font": "FiraCodeNerdFont-Regular 13",
            "Non Ascii Font": "FiraCodeNerdFont-Regular 13",
            "Use Non-ASCII Font": false
          }
        ]
      }
    dest: "{{ ansible_facts['env']['HOME'] }}/Library/Application Support/iTerm2/DynamicProfiles/firacode.json"
    mode: "0644"

- name: Display font configuration message
  ansible.builtin.debug:
    msg: |
      FiraCode Nerd Font has been configured.
      
      Terminal.app: Font is set in the "Basic" profile (restart Terminal to apply)
      iTerm2: A "FiraCode" profile has been created. Set it as default in:
        iTerm2 → Settings → Profiles → Other Actions → Set as Default

- name: Restart Finder to apply changes
  ansible.builtin.command: killall Finder
  changed_when: true
  failed_when: false

- name: Restart Dock to apply changes
  ansible.builtin.command: killall Dock
  changed_when: true
  failed_when: false
