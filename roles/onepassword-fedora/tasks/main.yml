---
# Additional setup for 1Password on Fedora 43

- name: Check if 1Password repository is already configured
  ansible.builtin.stat:
    path: /etc/yum.repos.d/1password.repo
  register: onepassword_repo

- name: Add 1Password GPG key
  ansible.builtin.rpm_key:
    key: https://downloads.1password.com/linux/keys/1password.asc
    state: present
  become: true
  when: not onepassword_repo.stat.exists

- name: Add 1Password repository
  ansible.builtin.yum_repository:
    name: 1password
    description: 1Password Stable Channel
    baseurl: https://downloads.1password.com/linux/rpm/stable/$basearch
    enabled: true
    gpgcheck: true
    gpgkey: https://downloads.1password.com/linux/keys/1password.asc
  become: true
  when: not onepassword_repo.stat.exists

- name: Refresh DNF cache after adding repository
  ansible.builtin.dnf:
    update_cache: true
  become: true
  when: not onepassword_repo.stat.exists

- name: Check available 1Password packages
  ansible.builtin.command: dnf list available | grep -i 1password
  register: onepassword_available
  changed_when: false
  failed_when: false
  become: true

- name: Display available 1Password packages
  ansible.builtin.debug:
    var: onepassword_available.stdout_lines

- name: Install 1Password (if available)
  ansible.builtin.dnf:
    name: 1password
    state: present
  become: true
  when: onepassword_available.rc == 0 and '1password' in onepassword_available.stdout
  register: onepassword_install
  failed_when: false

- name: Install 1Password CLI (if available)
  ansible.builtin.dnf:
    name: 1password-cli
    state: present
  become: true
  when: onepassword_available.rc == 0 and '1password-cli' in onepassword_available.stdout
  register: onepassword_cli_install
  failed_when: false

- name: Display 1Password installation note
  ansible.builtin.debug:
    msg: "1Password may need to be installed manually from https://1password.com/downloads/linux/"
  when: onepassword_install is skipped or (onepassword_install.failed | default(false))
