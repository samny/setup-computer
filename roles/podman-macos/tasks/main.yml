---
- name: Check if Podman machine exists
  ansible.builtin.command: podman machine list --format json
  register: podman_machine_list
  changed_when: false
  failed_when: false

- name: Initialize Podman machine with native ARM64 (no Rosetta)
  ansible.builtin.command: >
    podman machine init
    --cpus 4
    --memory 4096
    --disk-size 50
    --rootful=false
    --user-mode-networking
  when: podman_machine_list.stdout == "[]" or podman_machine_list.rc != 0
  changed_when: true
  environment:
    CONTAINERS_MACHINE_PROVIDER: applehv

- name: Display Podman machine info
  ansible.builtin.debug:
    msg: "Podman machine initialized with native Apple Silicon support using Apple Hypervisor (no Rosetta)"
  when: podman_machine_list.stdout == "[]" or podman_machine_list.rc != 0

- name: Start Podman machine
  ansible.builtin.command: podman machine start
  register: podman_start
  changed_when: "'Already running' not in podman_start.stderr"
  failed_when: podman_start.rc != 0 and 'Already running' not in podman_start.stderr
