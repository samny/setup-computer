---
- name: Verify 1Password CLI is installed
  ansible.builtin.command: which op
  register: op_check
  failed_when: false
  changed_when: false

- name: Check if 1Password CLI is authenticated
  ansible.builtin.command: op account list
  register: op_auth_check
  failed_when: false
  changed_when: false
  when: op_check.rc == 0

- name: Display 1Password authentication status
  ansible.builtin.debug:
    msg: "1Password CLI is {{ 'authenticated âœ“' if (op_auth_check.rc | default(1)) == 0 else 'NOT authenticated. Run: op signin' }}"
  when: op_check.rc == 0

- name: Warn if 1Password CLI not authenticated
  ansible.builtin.debug:
    msg: "WARNING: 1Password CLI is not authenticated. Secrets in dotfiles won't work until you run 'op signin'"
  when: op_check.rc == 0 and (op_auth_check.rc | default(1)) != 0

- name: Get current shell
  ansible.builtin.command: echo $SHELL
  register: current_shell
  changed_when: false

- name: Check if Fish is already the default shell
  ansible.builtin.set_fact:
    fish_is_default: "{{ 'fish' in current_shell.stdout }}"

- name: Display current shell
  ansible.builtin.debug:
    msg: "Current shell: {{ current_shell.stdout }}"

- name: Add Fish to allowed shells
  ansible.builtin.lineinfile:
    path: /etc/shells
    line: "{{ fish_shell_path }}"
    state: present
  become: true
  when: not fish_is_default

- name: Change default shell to Fish
  ansible.builtin.command: "chsh -s {{ fish_shell_path }}"
  become: true
  when: not fish_is_default
  changed_when: true

- name: Display shell change message
  ansible.builtin.debug:
    msg: "Fish shell is now your default shell. Please restart your terminal or log out and back in."
  when: not fish_is_default
